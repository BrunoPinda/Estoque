<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Estoque - Versão 3</title>
    <!-- Bootstrap 5.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- SheetJS para importar Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #4a5568;
            --secondary-color: #6366f1;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --light-bg: #f8fafc;
            --dark-bg: #1a202c;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 1200px;
            overflow: hidden;
        }
        
        .header-section {
            background: var(--primary-color);
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
        }
        
        .header-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
        }
        
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            padding: 2rem;
            background: #f8fafc;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--secondary-color);
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .nav-tabs {
            border-bottom: 2px solid #e2e8f0;
            background: white;
            padding: 0 2rem;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #64748b;
            font-weight: 500;
            padding: 1rem 1.5rem;
            border-radius: 0;
            position: relative;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--secondary-color);
            background: transparent;
            border-bottom: 3px solid var(--secondary-color);
        }
        
        .tab-content {
            padding: 2rem;
        }
        
        .form-section {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .table thead th {
            background: var(--primary-color);
            color: white;
            border: none;
            font-weight: 500;
            padding: 1rem 0.75rem;
        }
        
        .table tbody tr:hover {
            background-color: #f8fafc;
        }
        
        .btn-custom {
            border-radius: 6px;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border: none;
            transition: all 0.2s;
        }
        
        .btn-primary-custom {
            background: var(--secondary-color);
            color: white;
        }
        
        .btn-primary-custom:hover {
            background: #5b21b6;
            transform: translateY(-1px);
        }
        
        .badge-custom {
            padding: 0.5rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-danger-custom {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .badge-success-custom {
            background: #dcfce7;
            color: #16a34a;
        }
        
        .badge-warning-custom {
            background: #fef3c7;
            color: #d97706;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 1rem;
        }
        
        .search-box input {
            padding-left: 2.5rem;
        }
        
        .search-box .bi {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
        }
        
        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .modal-header {
            background: var(--primary-color);
            color: white;
            border-radius: 15px 15px 0 0;
        }
        
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .footer-credits {
            background: var(--primary-color);
            color: white;
            text-align: center;
            padding: 1rem;
            font-size: 0.9rem;
        }
        
        /* Dark mode */
        [data-bs-theme="dark"] {
            --bs-body-bg: #1a202c;
            --bs-body-color: #e2e8f0;
        }
        
        [data-bs-theme="dark"] .main-container {
            background: rgba(26, 32, 44, 0.95);
        }
        
        [data-bs-theme="dark"] .stat-card,
        [data-bs-theme="dark"] .form-section,
        [data-bs-theme="dark"] .table-container {
            background: #2d3748;
            color: #e2e8f0;
        }
        
        [data-bs-theme="dark"] .stats-cards {
            background: #2d3748;
        }
        
        [data-bs-theme="dark"] .nav-tabs {
            background: #2d3748;
        }
        
        /* Print styles */
        @media print {
            body {
                background: white !important;
            }
            .main-container {
                background: white !important;
                box-shadow: none !important;
                margin: 0 !important;
                max-width: none !important;
            }
            .no-print {
                display: none !important;
            }
            .nav-tabs, .theme-toggle {
                display: none !important;
            }
            .tab-content {
                display: block !important;
            }
            .tab-pane {
                display: block !important;
            }
        }
    </style>
</head>
<body>
    <!-- Theme Toggle Button -->
    <button class="theme-toggle no-print" onclick="toggleTheme()" id="themeToggle">
        <i class="bi bi-moon-fill"></i>
    </button>

    <div class="main-container">
        <!-- Header -->
        <div class="header-section">
            <div class="header-content">
                <h1 class="mb-2">
                    <i class="bi bi-boxes me-2"></i>
                    Controle de Estoque
                </h1>
                <p class="mb-0">Sistema completo para gerenciamento local</p>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-number" id="totalProdutos">0</div>
                <div class="stat-label">Total de Produtos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="itensEstoque">0</div>
                <div class="stat-label">Itens em Estoque</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="estoqueBaixo">0</div>
                <div class="stat-label">Estoque Baixo</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="produtosVencidos">0</div>
                <div class="stat-label">Produtos Vencidos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="valorTotal">R$ 0,00</div>
                <div class="stat-label">Valor Total</div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="produtos-tab" data-bs-toggle="tab" data-bs-target="#produtos" type="button" role="tab">
                    <i class="bi bi-box me-2"></i>Produtos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="movimentacao-tab" data-bs-toggle="tab" data-bs-target="#movimentacao" type="button" role="tab">
                    <i class="bi bi-arrow-left-right me-2"></i>Movimentação
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="relatorios-tab" data-bs-toggle="tab" data-bs-target="#relatorios" type="button" role="tab">
                    <i class="bi bi-graph-up me-2"></i>Relatórios
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="backup-tab" data-bs-toggle="tab" data-bs-target="#backup" type="button" role="tab">
                    <i class="bi bi-cloud-download me-2"></i>Backup
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabContent">
            <!-- Produtos Tab -->
            <div class="tab-pane fade show active" id="produtos" role="tabpanel">
                <!-- Cadastro Form -->
                <div class="form-section">
                    <h4 class="mb-3">Cadastro de Produtos</h4>
                    <form id="formProduto" onsubmit="adicionarProduto(event)">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Nome do Produto</label>
                                <input type="text" class="form-control" id="nomeProduto" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Código/SKU</label>
                                <input type="text" class="form-control" id="codigoProduto" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Quantidade</label>
                                <input type="number" class="form-control" id="quantidadeProduto" min="0" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Preço Unitário</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" class="form-control" id="precoProduto" step="0.01" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Estoque Mínimo</label>
                                <input type="number" class="form-control" id="estoqueMinimo" min="0" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Categoria</label>
                                <div class="input-group">
                                    <select class="form-select" id="categoriaProduto" onchange="verificarOutraCategoria()" required>
                                        <option value="">Selecione...</option>
                                        <option value="Alimentos">Alimentos</option>
                                        <option value="Bebidas">Bebidas</option>
                                        <option value="Limpeza">Limpeza</option>
                                        <option value="Higiene">Higiene</option>
                                        <option value="Material de Escritório">Material de Escritório</option>
                                        <option value="Outros">Outros</option>
                                        <option value="nova">+ Nova Categoria</option>
                                    </select>
                                </div>
                                <input type="text" class="form-control mt-2" id="novaCategoria" 
                                       placeholder="Digite a nova categoria" style="display: none;">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Data de Validade</label>
                                <input type="date" class="form-control" id="validadeProduto">
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Lote (opcional)</label>
                                <input type="text" class="form-control" id="loteProduto">
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary-custom btn-custom">
                                <i class="bi bi-plus-circle me-2"></i>Cadastrar Produto
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-custom ms-2" onclick="limparFormulario()">
                                <i class="bi bi-arrow-clockwise me-2"></i>Limpar
                            </button>
                        </div>
                    </form>
                    
                    <!-- Import Excel -->
                    <div class="mt-3">
                        <input type="file" class="form-control" id="importExcel" accept=".xlsx,.xls" onchange="importarExcel(event)" style="display: none;">
                        <button type="button" class="btn btn-outline-info btn-custom" onclick="document.getElementById('importExcel').click()">
                            <i class="bi bi-file-earmark-excel me-2"></i>Importar do Excel
                        </button>
                    </div>
                </div>

                <!-- Search -->
                <div class="search-box">
                    <input type="text" class="form-control" id="searchProdutos" placeholder="Buscar produtos..." onkeyup="filtrarProdutos()">
                    <i class="bi bi-search"></i>
                </div>

                <!-- Products Table -->
                <div class="table-container">
                    <table class="table table-hover mb-0" id="tabelaProdutos">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Nome</th>
                                <th>Quantidade</th>
                                <th>Preço</th>
                                <th>Categoria</th>
                                <th>Validade</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Movimentação Tab -->
            <div class="tab-pane fade" id="movimentacao" role="tabpanel">
                <div class="form-section">
                    <h4 class="mb-3">Movimentação de Estoque</h4>
                    <form id="formMovimentacao" onsubmit="registrarMovimentacao(event)">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Data</label>
                                <input type="date" class="form-control" id="dataMovimentacao" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Produto</label>
                                <select class="form-select" id="produtoMovimentacao" required>
                                    <option value="">Selecione um produto...</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Tipo</label>
                                <select class="form-select" id="tipoMovimentacao" required>
                                    <option value="Entrada">Entrada</option>
                                    <option value="Saída">Saída</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Quantidade</label>
                                <input type="number" class="form-control" id="quantidadeMovimentacao" min="1" required>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Observação</label>
                                <input type="text" class="form-control" id="observacaoMovimentacao" placeholder="Motivo da movimentação...">
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-success btn-custom">
                                <i class="bi bi-check-circle me-2"></i>Registrar Movimentação
                            </button>
                        </div>
                    </form>
                </div>

                <div class="table-container">
                    <table class="table table-hover mb-0" id="tabelaMovimentacao">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Produto</th>
                                <th>Tipo</th>
                                <th>Quantidade</th>
                                <th>Observação</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Relatórios Tab -->
            <div class="tab-pane fade" id="relatorios" role="tabpanel">
                <div class="form-section">
                    <h4 class="mb-3">Filtros de Relatório</h4>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Categoria</label>
                            <select class="form-select" id="filtroCategoria" onchange="atualizarRelatorio()">
                                <option value="">Todas as categorias</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Data Inicial</label>
                            <input type="date" class="form-control" id="dataInicial" onchange="atualizarRelatorio()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Data Final</label>
                            <input type="date" class="form-control" id="dataFinal" onchange="atualizarRelatorio()">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-primary btn-custom me-2" onclick="window.print()">
                                <i class="bi bi-printer me-2"></i>Imprimir
                            </button>
                            <button type="button" class="btn btn-outline-success btn-custom" onclick="exportarExcel()">
                                <i class="bi bi-file-earmark-excel me-2"></i>Excel
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table table-hover mb-0" id="tabelaRelatorio">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Nome</th>
                                <th>Categoria</th>
                                <th>Qtd Atual</th>
                                <th>Preço</th>
                                <th>Valor Total</th>
                                <th>Validade</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Backup Tab -->
            <div class="tab-pane fade" id="backup" role="tabpanel">
                <div class="form-section">
                    <h4 class="mb-3">Backup e Restauração</h4>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <h6>Fazer Backup</h6>
                            <p class="text-muted">Baixe todos os dados do sistema em formato JSON.</p>
                            <button type="button" class="btn btn-primary-custom btn-custom" onclick="fazerBackup()">
                                <i class="bi bi-download me-2"></i>Fazer Backup
                            </button>
                        </div>
                        <div class="col-md-6">
                            <h6>Restaurar Backup</h6>
                            <p class="text-muted">Carregue um arquivo de backup para restaurar os dados.</p>
                            <input type="file" class="form-control mb-2" id="inputRestore" accept=".json" onchange="restaurarBackup(event)">
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="row">
                        <div class="col-md-12">
                            <h6 class="text-danger">Zona de Perigo</h6>
                            <p class="text-muted">Esta ação irá apagar todos os dados do sistema permanentemente.</p>
                            <button type="button" class="btn btn-danger btn-custom" onclick="abrirModalLimpar()">
                                <i class="bi bi-trash me-2"></i>Limpar Tudo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Log de Ações -->
                <div class="form-section">
                    <h5 class="mb-3">Histórico de Ações</h5>
                    <div id="logContainer" style="max-height: 300px; overflow-y: auto; background: #f8fafc; padding: 1rem; border-radius: 8px;">
                        <!-- Logs serão inseridos aqui -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer-credits">
            Sistema criado em Junho de 2025 por BrunoOliveira — Versão_3
        </div>
    </div>

    <!-- Modal para Senha -->
    <div class="modal fade" id="modalSenha" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-shield-lock me-2"></i>Confirmação de Segurança
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Digite a senha para confirmar que deseja limpar todos os dados:</p>
                    <input type="password" class="form-control" id="senhaLimpar" placeholder="Digite a senha">
                    <small class="text-muted">Esta ação não pode ser desfeita.</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="confirmarLimpeza()">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Variáveis globais
        let produtos = [];
        let movimentacoes = [];
        let logs = [];
        const SENHA_ADMIN = "admin123"; // Altere para uma senha segura

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            carregarDados();
            atualizarTodasTabelas();
            atualizarEstatisticas();
            document.getElementById('dataMovimentacao').value = new Date().toISOString().split('T')[0];
        });

        // Tema claro/escuro
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-bs-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            html.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            const icon = document.querySelector('#themeToggle i');
            icon.className = newTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
        }

        // Carregar tema salvo
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
            const icon = document.querySelector('#themeToggle i');
            icon.className = savedTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
        })();

        // Gerenciamento de dados
        function salvarDados() {
            localStorage.setItem('produtos', JSON.stringify(produtos));
            localStorage.setItem('movimentacoes', JSON.stringify(movimentacoes));
            localStorage.setItem('logs', JSON.stringify(logs));
        }

        function carregarDados() {
            produtos = JSON.parse(localStorage.getItem('produtos') || '[]');
            movimentacoes = JSON.parse(localStorage.getItem('movimentacoes') || '[]');
            logs = JSON.parse(localStorage.getItem('logs') || '[]');
        }

        function registrarLog(acao) {
            const log = {
                data: new Date().toLocaleString('pt-BR'),
                acao: acao,
                usuario: 'Sistema Local'
            };
            logs.unshift(log);
            
            // Manter apenas os últimos 100 logs
            if (logs.length > 100) {
                logs = logs.slice(0, 100);
            }
            
            salvarDados();
            atualizarLogs();
        }

        function atualizarLogs() {
            const container = document.getElementById('logContainer');
            if (logs.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhuma ação registrada ainda.</p>';
                return;
            }
            
            container.innerHTML = logs.map(log => `
                <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                    <span>${log.acao}</span>
                    <small class="text-muted">${log.data}</small>
                </div>
            `).join('');
        }

        // Categoria personalizada
        function verificarOutraCategoria() {
            const select = document.getElementById('categoriaProduto');
            const inputNova = document.getElementById('novaCategoria');
            
            if (select.value === 'nova') {
                inputNova.style.display = 'block';
                inputNova.required = true;
                inputNova.focus();
            } else {
                inputNova.style.display = 'none';
                inputNova.required = false;
                inputNova.value = '';
            }
        }

        function obterCategoriaFinal() {
            const select = document.getElementById('categoriaProduto');
            const inputNova = document.getElementById('novaCategoria');
            
            if (select.value === 'nova' && inputNova.value.trim()) {
                return inputNova.value.trim();
            }
            return select.value;
        }

        function adicionarCategoriaAoSelect(novaCategoria) {
            const select = document.getElementById('categoriaProduto');
            const opcaoNova = select.querySelector('option[value="nova"]');
            
            // Verificar se a categoria já existe
            const existe = Array.from(select.options).some(option => 
                option.value === novaCategoria && option.value !== 'nova'
            );
            
            if (!existe && novaCategoria) {
                const novaOpcao = document.createElement('option');
                novaOpcao.value = novaCategoria;
                novaOpcao.textContent = novaCategoria;
                
                // Inserir antes da opção "Nova Categoria"
                select.insertBefore(novaOpcao, opcaoNova);
            }
        }

        function atualizarFiltroCategoria() {
            const categorias = [...new Set(produtos.map(p => p.categoria))].sort();
            const filtroSelect = document.getElementById('filtroCategoria');
            
            // Manter a primeira opção "Todas as categorias"
            filtroSelect.innerHTML = '<option value="">Todas as categorias</option>';
            
            categorias.forEach(categoria => {
                if (categoria) {
                    const option = document.createElement('option');
                    option.value = categoria;
                    option.textContent = categoria;
                    filtroSelect.appendChild(option);
                }
            });
        }

        // Produtos
        function adicionarProduto(event) {
            event.preventDefault();
            
            const categoriaFinal = obterCategoriaFinal();
            
            if (!categoriaFinal) {
                alert('Por favor, selecione ou digite uma categoria.');
                return;
            }

            const produto = {
                id: Date.now(),
                codigo: document.getElementById('codigoProduto').value.trim(),
                nome: document.getElementById('nomeProduto').value.trim(),
                quantidade: parseInt(document.getElementById('quantidadeProduto').value),
                preco: parseFloat(document.getElementById('precoProduto').value),
                estoqueMinimo: parseInt(document.getElementById('estoqueMinimo').value),
                categoria: categoriaFinal,
                validade: document.getElementById('validadeProduto').value,
                lote: document.getElementById('loteProduto').value.trim(),
                dataCadastro: new Date().toISOString().split('T')[0]
            };

            // Validações
            if (produtos.some(p => p.codigo === produto.codigo)) {
                alert('Código já existe! Use um código diferente.');
                return;
            }

            // Adicionar nova categoria ao select se for uma categoria personalizada
            if (document.getElementById('categoriaProduto').value === 'nova') {
                adicionarCategoriaAoSelect(categoriaFinal);
            }

            produtos.push(produto);
            registrarLog(`Produto cadastrado: ${produto.nome} (${produto.codigo})`);
            salvarDados();
            atualizarTodasTabelas();
            atualizarEstatisticas();
            limparFormulario();
            
            // Mostrar mensagem de sucesso
            mostrarToast('Produto cadastrado com sucesso!', 'success');
        }

        function limparFormulario() {
            document.getElementById('formProduto').reset();
            document.getElementById('novaCategoria').style.display = 'none';
            document.getElementById('novaCategoria').required = false;
        }

        function editarProduto(id) {
            const produto = produtos.find(p => p.id === id);
            if (!produto) return;

            document.getElementById('codigoProduto').value = produto.codigo;
            document.getElementById('nomeProduto').value = produto.nome;
            document.getElementById('quantidadeProduto').value = produto.quantidade;
            document.getElementById('precoProduto').value = produto.preco;
            document.getElementById('estoqueMinimo').value = produto.estoqueMinimo;
            
            // Verificar se a categoria existe no select
            const select = document.getElementById('categoriaProduto');
            const opcaoExiste = Array.from(select.options).some(option => option.value === produto.categoria);
            
            if (opcaoExiste) {
                select.value = produto.categoria;
            } else {
                // Se não existe, adicionar e selecionar
                adicionarCategoriaAoSelect(produto.categoria);
                select.value = produto.categoria;
            }
            
            document.getElementById('validadeProduto').value = produto.validade;
            document.getElementById('loteProduto').value = produto.lote;

            // Remover produto para permitir edição
            produtos = produtos.filter(p => p.id !== id);
            atualizarTodasTabelas();
            atualizarEstatisticas();
        }

        function excluirProduto(id) {
            const produto = produtos.find(p => p.id === id);
            if (!produto) return;

            if (confirm(`Tem certeza que deseja excluir o produto "${produto.nome}"?`)) {
                produtos = produtos.filter(p => p.id !== id);
                registrarLog(`Produto excluído: ${produto.nome} (${produto.codigo})`);
                salvarDados();
                atualizarTodasTabelas();
                atualizarEstatisticas();
                mostrarToast('Produto excluído com sucesso!', 'success');
            }
        }

        function filtrarProdutos() {
            const filtro = document.getElementById('searchProdutos').value.toLowerCase();
            const linhas = document.querySelectorAll('#tabelaProdutos tbody tr');
            
            linhas.forEach(linha => {
                const texto = linha.textContent.toLowerCase();
                linha.style.display = texto.includes(filtro) ? '' : 'none';
            });
        }

        // Movimentação
        function registrarMovimentacao(event) {
            event.preventDefault();
            
            const produtoId = parseInt(document.getElementById('produtoMovimentacao').value);
            const tipo = document.getElementById('tipoMovimentacao').value;
            const quantidade = parseInt(document.getElementById('quantidadeMovimentacao').value);
            const observacao = document.getElementById('observacaoMovimentacao').value.trim();
            const data = document.getElementById('dataMovimentacao').value;

            const produto = produtos.find(p => p.id === produtoId);
            if (!produto) {
                alert('Produto não encontrado!');
                return;
            }

            // Validar estoque para saída
            if (tipo === 'Saída' && produto.quantidade < quantidade) {
                alert(`Estoque insuficiente! Disponível: ${produto.quantidade}`);
                return;
            }

            // Atualizar estoque
            if (tipo === 'Entrada') {
                produto.quantidade += quantidade;
            } else {
                produto.quantidade -= quantidade;
            }

            // Registrar movimentação
            const movimentacao = {
                id: Date.now(),
                produtoId: produtoId,
                produtoNome: produto.nome,
                tipo: tipo,
                quantidade: quantidade,
                observacao: observacao,
                data: data,
                dataHora: new Date().toLocaleString('pt-BR')
            };

            movimentacoes.unshift(movimentacao);
            registrarLog(`${tipo}: ${quantidade} unidades de ${produto.nome}`);
            salvarDados();
            atualizarTodasTabelas();
            atualizarEstatisticas();
            document.getElementById('formMovimentacao').reset();
            document.getElementById('dataMovimentacao').value = new Date().toISOString().split('T')[0];
            
            mostrarToast(`${tipo} registrada com sucesso!`, 'success');
        }

        // Atualizar tabelas
        function atualizarTodasTabelas() {
            atualizarTabelaProdutos();
            atualizarSelectProdutos();
            atualizarTabelaMovimentacao();
            atualizarRelatorio();
            atualizarFiltroCategoria();
            atualizarLogs();
        }

        function atualizarTabelaProdutos() {
            const tbody = document.querySelector('#tabelaProdutos tbody');
            
            if (produtos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Nenhum produto cadastrado</td></tr>';
                return;
            }

            tbody.innerHTML = produtos.map(produto => {
                const status = getStatusProduto(produto);
                const badgeClass = status.includes('VENCIDO') ? 'badge-danger-custom' : 
                                 status.includes('BAIXO') ? 'badge-warning-custom' : 
                                 status.includes('SEM VALIDADE') ? 'badge-danger-custom' : 'badge-success-custom';

                return `
                    <tr>
                        <td>${produto.codigo}</td>
                        <td>${produto.nome}</td>
                        <td>${produto.quantidade}</td>
                        <td>R$ ${produto.preco.toFixed(2)}</td>
                        <td>${produto.categoria}</td>
                        <td>${produto.validade || 'Não informada'}</td>
                        <td><span class="badge ${badgeClass}">${status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editarProduto(${produto.id})" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="excluirProduto(${produto.id})" title="Excluir">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function atualizarSelectProdutos() {
            const select = document.getElementById('produtoMovimentacao');
            select.innerHTML = '<option value="">Selecione um produto...</option>' +
                produtos.map(p => `<option value="${p.id}">${p.nome} (${p.codigo})</option>`).join('');
        }

        function atualizarTabelaMovimentacao() {
            const tbody = document.querySelector('#tabelaMovimentacao tbody');
            
            if (movimentacoes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhuma movimentação registrada</td></tr>';
                return;
            }

            tbody.innerHTML = movimentacoes.slice(0, 50).map(mov => `
                <tr>
                    <td>${mov.data}</td>
                    <td>${mov.produtoNome}</td>
                    <td>
                        <span class="badge ${mov.tipo === 'Entrada' ? 'bg-success' : 'bg-danger'}">
                            ${mov.tipo}
                        </span>
                    </td>
                    <td>${mov.quantidade}</td>
                    <td>${mov.observacao || '-'}</td>
                </tr>
            `).join('');
        }

        function atualizarRelatorio() {
            const tbody = document.querySelector('#tabelaRelatorio tbody');
            const filtroCategoria = document.getElementById('filtroCategoria').value;
            const dataInicial = document.getElementById('dataInicial').value;
            const dataFinal = document.getElementById('dataFinal').value;

            let produtosFiltrados = produtos.slice();

            // Filtrar por categoria
            if (filtroCategoria) {
                produtosFiltrados = produtosFiltrados.filter(p => p.categoria === filtroCategoria);
            }

            // Filtrar por período (usando data de validade)
            if (dataInicial || dataFinal) {
                produtosFiltrados = produtosFiltrados.filter(produto => {
                    if (!produto.validade) return false;
                    const validadeProduto = new Date(produto.validade);
                    
                    if (dataInicial && validadeProduto < new Date(dataInicial)) return false;
                    if (dataFinal && validadeProduto > new Date(dataFinal)) return false;
                    
                    return true;
                });
            }

            if (produtosFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Nenhum produto encontrado com os filtros aplicados</td></tr>';
                return;
            }

            tbody.innerHTML = produtosFiltrados.map(produto => {
                const valorTotal = produto.quantidade * produto.preco;
                const status = getStatusProduto(produto);
                const badgeClass = status.includes('VENCIDO') ? 'badge-danger-custom' : 
                                 status.includes('BAIXO') ? 'badge-warning-custom' : 
                                 status.includes('SEM VALIDADE') ? 'badge-danger-custom' : 'badge-success-custom';

                return `
                    <tr>
                        <td>${produto.codigo}</td>
                        <td>${produto.nome}</td>
                        <td>${produto.categoria}</td>
                        <td>${produto.quantidade}</td>
                        <td>R$ ${produto.preco.toFixed(2)}</td>
                        <td>R$ ${valorTotal.toFixed(2)}</td>
                        <td>${produto.validade || 'Não informada'}</td>
                        <td><span class="badge ${badgeClass}">${status}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function getStatusProduto(produto) {
            if (!produto.validade) return 'SEM VALIDADE';
            
            const hoje = new Date();
            const validade = new Date(produto.validade);
            const diasParaVencer = Math.ceil((validade - hoje) / (1000 * 60 * 60 * 24));
            
            if (diasParaVencer < 0) return 'VENCIDO';
            if (diasParaVencer <= 7) return 'VENCE EM BREVE';
            if (produto.quantidade <= produto.estoqueMinimo) return 'ESTOQUE BAIXO';
            
            return 'VÁLIDO';
        }

        // Estatísticas
        function atualizarEstatisticas() {
            const totalProdutos = produtos.length;
            const itensEstoque = produtos.reduce((total, p) => total + p.quantidade, 0);
            const estoqueBaixo = produtos.filter(p => p.quantidade <= p.estoqueMinimo).length;
            
            let produtosVencidos = 0;
            const hoje = new Date();
            produtos.forEach(produto => {
                if (produto.validade) {
                    const validade = new Date(produto.validade);
                    if (validade < hoje) produtosVencidos++;
                }
            });
            
            const valorTotal = produtos.reduce((total, p) => total + (p.quantidade * p.preco), 0);

            document.getElementById('totalProdutos').textContent = totalProdutos;
            document.getElementById('itensEstoque').textContent = itensEstoque;
            document.getElementById('estoqueBaixo').textContent = estoqueBaixo;
            document.getElementById('produtosVencidos').textContent = produtosVencidos;
            document.getElementById('valorTotal').textContent = `R$ ${valorTotal.toFixed(2)}`;
        }

        // Backup e Restauração
        function fazerBackup() {
            const dados = {
                produtos: produtos,
                movimentacoes: movimentacoes,
                logs: logs,
                dataBackup: new Date().toISOString(),
                versao: '3.0'
            };

            const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_estoque_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            registrarLog('Backup realizado');
            mostrarToast('Backup realizado com sucesso!', 'success');
        }

        function restaurarBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dados = JSON.parse(e.target.result);
                    
                    if (dados.produtos && dados.movimentacoes && dados.logs) {
                        if (confirm('Tem certeza que deseja restaurar o backup? Todos os dados atuais serão substituídos.')) {
                            produtos = dados.produtos;
                            movimentacoes = dados.movimentacoes;
                            logs = dados.logs;
                            
                            salvarDados();
                            atualizarTodasTabelas();
                            atualizarEstatisticas();
                            
                            registrarLog('Backup restaurado');
                            mostrarToast('Backup restaurado com sucesso!', 'success');
                        }
                    } else {
                        throw new Error('Formato de backup inválido');
                    }
                } catch (error) {
                    alert('Erro ao restaurar backup: Arquivo inválido');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function abrirModalLimpar() {
            const modal = new bootstrap.Modal(document.getElementById('modalSenha'));
            modal.show();
        }

        function confirmarLimpeza() {
            const senha = document.getElementById('senhaLimpar').value;
            
            if (senha === SENHA_ADMIN) {
                produtos = [];
                movimentacoes = [];
                logs = [];
                
                salvarDados();
                atualizarTodasTabelas();
                atualizarEstatisticas();
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalSenha'));
                modal.hide();
                document.getElementById('senhaLimpar').value = '';
                
                registrarLog('Todos os dados foram limpos');
                mostrarToast('Todos os dados foram limpos!', 'warning');
            } else {
                alert('Senha incorreta!');
            }
        }

        // Importar Excel
        function importarExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    let importados = 0;
                    let erros = 0;

                    // Assumindo que a primeira linha são os cabeçalhos
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row.length < 6) continue; // Pular linhas incompletas

                        try {
                            const produto = {
                                id: Date.now() + i,
                                codigo: String(row[0] || '').trim(),
                                nome: String(row[1] || '').trim(),
                                quantidade: parseInt(row[2]) || 0,
                                preco: parseFloat(row[3]) || 0,
                                estoqueMinimo: parseInt(row[4]) || 0,
                                categoria: String(row[5] || 'Outros').trim(),
                                validade: row[6] ? String(row[6]).split('T')[0] : '',
                                lote: String(row[7] || '').trim(),
                                dataCadastro: new Date().toISOString().split('T')[0]
                            };

                            // Validar se o código já existe
                            if (produto.codigo && produto.nome && !produtos.some(p => p.codigo === produto.codigo)) {
                                produtos.push(produto);
                                
                                // Adicionar categoria ao select se for nova
                                adicionarCategoriaAoSelect(produto.categoria);
                                
                                importados++;
                            } else {
                                erros++;
                            }
                        } catch (error) {
                            erros++;
                        }
                    }

                    if (importados > 0) {
                        registrarLog(`Importados ${importados} produtos do Excel`);
                        salvarDados();
                        atualizarTodasTabelas();
                        atualizarEstatisticas();
                    }

                    mostrarToast(`Importação concluída: ${importados} produtos importados, ${erros} erros`, 'info');
                } catch (error) {
                    alert('Erro ao importar arquivo Excel');
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        // Exportar Excel
        function exportarExcel() {
            const ws = XLSX.utils.json_to_sheet(produtos.map(p => ({
                'Código': p.codigo,
                'Nome': p.nome,
                'Quantidade': p.quantidade,
                'Preço': p.preco,
                'Estoque Mínimo': p.estoqueMinimo,
                'Categoria': p.categoria,
                'Validade': p.validade,
                'Lote': p.lote,
                'Status': getStatusProduto(p)
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Produtos');
            XLSX.writeFile(wb, `relatorio_estoque_${new Date().toISOString().split('T')[0]}.xlsx`);

            registrarLog('Relatório exportado para Excel');
            mostrarToast('Relatório exportado com sucesso!', 'success');
        }

        // Toast notifications
        function mostrarToast(mensagem, tipo = 'info') {
            // Criar toast dinamicamente
            const toastContainer = document.getElementById('toastContainer') || createToastContainer();
            
            const toastId = 'toast_' + Date.now();
            const toastHtml = `
                <div class="toast align-items-center text-bg-${tipo} border-0" role="alert" id="${toastId}">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${mensagem}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // Remover toast após ser escondido
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            container.style.zIndex = '1055';
            document.body.appendChild(container);
            return container;
        }
    </script>
</body>
</html>
